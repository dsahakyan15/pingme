# Улучшения WebSocket для постоянного обмена данными и синхронизации истории

## Обзор изменений

Был улучшен хук `useWebSocketRTK` для обеспечения постоянного обмена данными и автоматической
синхронизации истории сообщений между пользователями.

## Ключевые функции

### 1. Автоматическая загрузка истории при подключении

При установлении WebSocket соединения автоматически запрашивается история сообщений и пользователей:

```typescript
websocket.onopen = () => {
  store.dispatch(connected());
  // Автоматически запрашиваем историю сообщений при подключении
  store.dispatch(requestHistory());
};
```

### 2. Новые действия Redux

Добавлены новые действия для управления историей:

- `requestHistory()` - запрос истории сообщений
- `historyReceived()` - получение и обработка истории
- Индикатор состояния загрузки `isLoadingHistory`

### 3. Обработка на сервере

Сервер теперь обрабатывает запросы истории:

```javascript
if (msg.type === 'history.request') {
  // Получаем все сообщения и пользователей из БД
  // Отправляем историю клиенту
}
```

### 4. Типизация

Добавлены новые типы для работы с историей:

```typescript
export interface EventPayloadMap {
  'history.request': Record<string, never>;
  // ... другие типы
}

interface HistoryResponse {
  type: 'history.response';
  messages: Message[];
  users: User[];
}
```

## Как использовать

### Базовое использование

```typescript
const { isConnected, isLoadingHistory, chatMessages, usersMap, requestHistory, sendMessage } =
  useWebSocketRTK();

// Подключение (история загружается автоматически)
useEffect(() => {
  connect('ws://localhost:3000');
}, [connect]);

// Ручной запрос истории
const handleRefreshHistory = () => {
  requestHistory();
};
```

### Отображение состояния загрузки

```typescript
return (
  <div>
    {isLoadingHistory && <div className="loading-indicator">Загружается история сообщений...</div>}

    {!isLoadingHistory && chatMessages.length === 0 && (
      <div>
        <p>История сообщений пуста</p>
        <button onClick={requestHistory}>Обновить историю</button>
      </div>
    )}

    {chatMessages.map((msg) => (
      <ChatMessage key={msg.message_id} msg={msg} />
    ))}
  </div>
);
```

## Синхронизация между пользователями

### Что происходит, когда новый пользователь подключается:

1. **Подключение к WebSocket** - устанавливается соединение
2. **Автоматический запрос истории** - отправляется `history.request`
3. **Получение данных** - сервер возвращает все сообщения и пользователей
4. **Обновление состояния** - Redux обновляется с полученными данными
5. **Отображение** - пользователь видит всю историю чата

### Постоянный обмен данными

- **Входящие сообщения** обрабатываются в реальном времени через `onmessage`
- **Исходящие сообщения** отправляются и сохраняются через `sendMessage`
- **Пользователи** синхронизируются автоматически при регистрации
- **Переподключение** восстанавливает историю автоматически

## Протокол WebSocket

### Запрос истории

```json
{
  "type": "history.request",
  "data": {},
  "timestamp": 1641234567890
}
```

### Ответ с историей

```json
{
  "type": "history.response",
  "data": {
    "messages": [
      {
        "message_id": 1,
        "conversation_id": 1,
        "sender_id": 1,
        "text": "Привет!",
        "sent_at": "2024-01-01T12:00:00Z"
      }
    ],
    "users": [
      {
        "user_id": 1,
        "username": "Alice"
      }
    ]
  }
}
```

## Архитектура

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   React Hook    │◄──►│   Redux Store    │◄──►│   WebSocket     │
│  useWebSocketRTK│    │   + Middleware   │    │   Middleware    │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         ▲                        ▲                        ▲
         │                        │                        │
         ▼                        ▼                        ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   UI Component  │    │    Selectors     │    │    Server       │
│   (ChatPage)    │    │                  │    │   (Node.js)     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

## Преимущества реализации

1. **Автоматическая синхронизация** - новые пользователи сразу видят историю
2. **Надёжность** - переподключение восстанавливает состояние
3. **Производительность** - история загружается только при необходимости
4. **Типобезопасность** - все данные строго типизированы
5. **Расширяемость** - легко добавить новые типы сообщений
6. **UX** - индикаторы загрузки и обработка ошибок

## Дальнейшие улучшения

- Пагинация для больших историй сообщений
- Кэширование истории в localStorage
- Инкрементальные обновления (только новые сообщения)
- Поддержка нескольких комнат/каналов
- Оптимистические обновления с откатом при ошибках
